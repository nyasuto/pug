#!/bin/sh
# pug ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ - Pre-commit ãƒ•ãƒƒã‚¯
# å“è³ªãƒã‚§ãƒƒã‚¯ã¨ãƒ–ãƒ©ãƒ³ãƒãƒ«ãƒ¼ãƒ«ã‚’å¼·åˆ¶

set -e

echo "ğŸª Pre-commit ãƒ•ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ã‚³ãƒŸãƒƒãƒˆç¦æ­¢
if [ "$current_branch" = "main" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ã‚³ãƒŸãƒƒãƒˆã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"
    echo "   æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„:"
    echo "   git checkout -b feat/your-feature-name"
    exit 1
fi

# ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ï¼‰
if [ "$current_branch" != "main" ]; then
    valid_patterns="^(feat|fix|hotfix|test|docs|ci|cicd|refactor|perf|security|deps)/"
    if ! echo "$current_branch" | grep -qE "$valid_patterns"; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåãŒå‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã›ã‚“: $current_branch"
        echo "   æ­£ã—ã„å½¢å¼:"
        echo "   - feat/issue-X-feature-name     (æ–°æ©Ÿèƒ½)"
        echo "   - fix/issue-X-description       (ãƒã‚°ä¿®æ­£)"
        echo "   - hotfix/X-description          (ç·Šæ€¥ä¿®æ­£)"
        echo "   - test/X-description            (ãƒ†ã‚¹ãƒˆ)"
        echo "   - docs/X-description            (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)"
        echo "   - ci/X-description              (CI/CD)"
        echo "   - refactor/X-description        (ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°)"
        echo "   - perf/X-description           (æ€§èƒ½æ”¹å–„)"
        echo "   - security/X-description        (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)"
        echo "   - deps/X-description           (ä¾å­˜é–¢ä¿‚)"
        exit 1
    fi
    
    # Issueå‚ç…§æ¨å¥¨ï¼ˆæ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆï¼‰
    if echo "$current_branch" | grep -qE "^(feat|fix|hotfix)/" && ! echo "$current_branch" | grep -qE "issue-[0-9]+"; then
        echo "â„¹ï¸  æƒ…å ±: ãƒ–ãƒ©ãƒ³ãƒåã«issueç•ªå·ã®å«æœ‰ã‚’æ¨å¥¨ã—ã¾ã™"
        echo "   æ¨å¥¨å½¢å¼: feat/issue-123-feature-name"
    fi
fi

# ç©ºã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
if [ -z "$(git diff --cached --name-only)" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
    exit 1
fi

# Go ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®å“è³ªãƒã‚§ãƒƒã‚¯
go_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
if [ -n "$go_files" ]; then
    echo "ğŸ” Go ãƒ•ã‚¡ã‚¤ãƒ«ã®å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
    
    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    echo "  âœ¨ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯..."
    unformatted=$(echo "$go_files" | xargs gofmt -l)
    if [ -n "$unformatted" ]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“:"
        echo "$unformatted"
        echo "   ä¿®æ­£ã™ã‚‹ã«ã¯: make fmt"
        exit 1
    fi
    
    
    # å¯èƒ½ã§ã‚ã‚Œã°lintãƒã‚§ãƒƒã‚¯
    if command -v golangci-lint >/dev/null 2>&1; then
        echo "  ğŸ” Lint ãƒã‚§ãƒƒã‚¯..."
        if ! golangci-lint run --new-from-rev=HEAD~1; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: Lint ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "   ä¿®æ­£ã™ã‚‹ã«ã¯: make lint"
            exit 1
        fi
    else
        echo "  âš ï¸  golangci-lint ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
    fi
    
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå¤‰æ›´ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ï¼‰
    echo "  ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
    packages=$(echo "$go_files" | xargs -I {} dirname {} | sort -u | xargs -I {} echo "./{}...")
    if [ -n "$packages" ]; then
        if ! go test $packages; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
        fi
    fi
fi

# Makefileã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆ
makefile_changed=$(git diff --cached --name-only | grep -E '^Makefile$' || true)
if [ -n "$makefile_changed" ]; then
    echo "ğŸ”§ Makefileæ§‹æ–‡ãƒã‚§ãƒƒã‚¯..."
    if ! make -n help >/dev/null 2>&1; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: Makefileæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
        exit 1
    fi
fi

# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆ
workflow_files=$(git diff --cached --name-only | grep '\.github/workflows/.*\.yml$' || true)
if [ -n "$workflow_files" ]; then
    echo "ğŸ”„ GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹æ–‡ãƒã‚§ãƒƒã‚¯..."
    # yamllintãŒã‚ã‚Œã°ä½¿ç”¨
    if command -v yamllint >/dev/null 2>&1; then
        echo "$workflow_files" | xargs yamllint
    else
        echo "  âš ï¸  yamllint ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
    fi
fi

# å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯ï¼ˆ5MBä»¥ä¸Šï¼‰
large_files=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(wc -c < "{}") -gt 5242880 ]; then echo "{}"; fi' || true)
if [ -n "$large_files" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: 5MBä»¥ä¸Šã®å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™:"
    echo "$large_files"
    echo "   å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã¯Git LFSã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€é™¤å¤–ã—ã¦ãã ã•ã„"
    exit 1
fi

# æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯ï¼ˆåŸºæœ¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
echo "ğŸ”’ æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯..."
secrets_pattern="(password|secret|key|token|api_key|private_key).*[:=].*['\"][^'\"]{8,}['\"]"
if git diff --cached | grep -iE "$secrets_pattern"; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: æ©Ÿå¯†æƒ…å ±ã®å¯èƒ½æ€§ãŒã‚ã‚‹å†…å®¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    echo "   APIã‚­ãƒ¼ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„"
    exit 1
fi

echo "âœ… Pre-commit ãƒã‚§ãƒƒã‚¯å®Œäº†"