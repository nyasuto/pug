#!/bin/sh
# pug ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ - Commit-msg ãƒ•ãƒƒã‚¯
# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦å‰‡ã‚’å¼·åˆ¶

set -e

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ç©ºã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
if [ -z "$(echo "$commit_msg" | sed '/^#/d' | sed '/^$/d')" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã§ã™"
    exit 1
fi

# ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
if echo "$commit_msg" | grep -q "^Merge "; then
    echo "ğŸ”€ ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
    exit 0
fi

# Conventional Commits å½¢å¼ãƒã‚§ãƒƒã‚¯
# å½¢å¼: <type>: <description>
valid_types="feat|fix|docs|style|refactor|test|chore|ci|perf|security|deps"
title_line=$(echo "$commit_msg" | head -n1)

if ! echo "$title_line" | grep -qE "^($valid_types): .+"; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒConventional Commitså½¢å¼ã«å¾“ã£ã¦ã„ã¾ã›ã‚“"
    echo ""
    echo "æ­£ã—ã„å½¢å¼:"
    echo "  <type>: <description>"
    echo ""
    echo "åˆ©ç”¨å¯èƒ½ãªtype:"
    echo "  feat:     æ–°æ©Ÿèƒ½"
    echo "  fix:      ãƒã‚°ä¿®æ­£"  
    echo "  docs:     ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"
    echo "  style:    ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ©Ÿèƒ½ã«å½±éŸ¿ã—ãªã„å¤‰æ›´ï¼‰"
    echo "  refactor: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°"
    echo "  test:     ãƒ†ã‚¹ãƒˆè¿½åŠ ãƒ»ä¿®æ­£"
    echo "  chore:    ãã®ä»–ã®ã‚¿ã‚¹ã‚¯"
    echo "  ci:       CI/CDé–¢é€£"
    echo "  perf:     æ€§èƒ½æ”¹å–„"
    echo "  security: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£"
    echo "  deps:     ä¾å­˜é–¢ä¿‚æ›´æ–°"
    echo ""
    echo "ä¾‹:"
    echo "  feat: Phase 1.0 ãƒ¬ã‚¯ã‚µãƒ¼å®Ÿè£…"
    echo "  fix: å‹æ¤œæŸ»ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£"
    echo "  docs: README ã®ä½¿ç”¨æ–¹æ³•æ›´æ–°"
    echo ""
    echo "ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:"
    echo "  $title_line"
    exit 1
fi

# ã‚¿ã‚¤ãƒˆãƒ«é•·ã•ãƒã‚§ãƒƒã‚¯ï¼ˆ72æ–‡å­—åˆ¶é™ï¼‰
title_length=$(echo "$title_line" | wc -c)
if [ $title_length -gt 72 ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ãŒé•·ã™ãã¾ã™ ($title_lengthæ–‡å­—)"
    echo "   72æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„"
    echo "   ç¾åœ¨: $title_line"
    exit 1
fi

# ã‚¿ã‚¤ãƒˆãƒ«ã®æœ«å°¾ã«ãƒ”ãƒªã‚ªãƒ‰ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
if echo "$title_line" | grep -q '\.$'; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«æœ«å°¾ã«ãƒ”ãƒªã‚ªãƒ‰ã¯ä¸è¦ã§ã™"
    echo "   ç¾åœ¨: $title_line"
    exit 1
fi

# èª¬æ˜æ–‡ãŒã‚ã‚‹å ´åˆã®å½¢å¼ãƒã‚§ãƒƒã‚¯
line_count=$(echo "$commit_msg" | sed '/^#/d' | wc -l)
if [ $line_count -gt 1 ]; then
    # 2è¡Œç›®ãŒç©ºè¡Œã‹ãƒã‚§ãƒƒã‚¯
    second_line=$(echo "$commit_msg" | sed -n '2p')
    if [ -n "$second_line" ] && [ "$second_line" != "" ]; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: 2è¡Œç›®ã¯ç©ºè¡Œã«ã—ã¦ãã ã•ã„"
        echo "   å½¢å¼: ã‚¿ã‚¤ãƒˆãƒ«è¡Œ + ç©ºè¡Œ + èª¬æ˜æ–‡"
        exit 1
    fi
    
    # æœ¬æ–‡ã®å„è¡ŒãŒ72æ–‡å­—ä»¥å†…ã‹ãƒã‚§ãƒƒã‚¯
    body_lines=$(echo "$commit_msg" | sed '1,2d' | sed '/^#/d')
    echo "$body_lines" | while IFS= read -r line; do
        if [ -n "$line" ]; then
            line_length=$(echo "$line" | wc -c)
            if [ $line_length -gt 72 ]; then
                echo "âŒ ã‚¨ãƒ©ãƒ¼: æœ¬æ–‡ã®è¡ŒãŒé•·ã™ãã¾ã™ ($line_lengthæ–‡å­—)"
                echo "   72æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„: $line"
                exit 1
            fi
        fi
    done
fi

# æ—¥æœ¬èªãƒã‚§ãƒƒã‚¯ï¼ˆæ–‡å­—åŒ–ã‘é˜²æ­¢ï¼‰
if echo "$commit_msg" | grep -q $'\x1b'; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
    exit 1
fi

# WIP/TODOãƒã‚§ãƒƒã‚¯ï¼ˆæœ¬ç•ªã§ã¯é¿ã‘ã‚‹ã¹ãï¼‰
if echo "$title_line" | grep -iqE "(wip|todo|fixme|hack|temp)"; then
    echo "âš ï¸  è­¦å‘Š: ä¸€æ™‚çš„ãªã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    echo "   ãƒ—ãƒƒã‚·ãƒ¥å‰ã«é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›´ã—ã¦ãã ã•ã„: $title_line"
fi

# Issueå‚ç…§ãƒã‚§ãƒƒã‚¯ï¼ˆæ©Ÿèƒ½è¿½åŠ ãƒ»ãƒã‚°ä¿®æ­£ã®å ´åˆï¼‰
if echo "$title_line" | grep -qE "^(feat|fix):" && ! echo "$commit_msg" | grep -qE "#[0-9]+"; then
    echo "â„¹ï¸  æƒ…å ±: Issueç•ªå·ã®å‚ç…§ã‚’æ¨å¥¨ã—ã¾ã™"
    echo "   ä¾‹: feat: Phase 1.0 ãƒ¬ã‚¯ã‚µãƒ¼å®Ÿè£… (#2)"
fi

# ã‚³ãƒŸãƒƒãƒˆã«Claude Codeç½²åã‚’è¿½åŠ 
if ! echo "$commit_msg" | grep -q "Generated with.*Claude Code"; then
    echo "" >> "$commit_msg_file"
    echo "ğŸ¤– Generated with [Claude Code](https://claude.ai/code)" >> "$commit_msg_file"
    echo "" >> "$commit_msg_file"
    echo "Co-Authored-By: Claude <noreply@anthropic.com>" >> "$commit_msg_file"
fi

echo "âœ… ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯å®Œäº†"