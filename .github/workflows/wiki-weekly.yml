name: ğŸ“ é€±æ¬¡Wikiè‡ªå‹•æ›´æ–°

on:
  schedule:
    # æ¯é€±æ—¥æ›œæ—¥ JST 10:00 (UTC 01:00) ã«å®Ÿè¡Œ
    - cron: '0 1 * * 0'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: read
  actions: read

jobs:
  wiki-weekly-update:
    name: ğŸ“š é€±æ¬¡WikiåŒ…æ‹¬æ›´æ–°
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æç”¨ï¼‰

    - name: ğŸ¹ Goç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: 'stable'
        cache: true

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        go mod download
        go mod tidy

    - name: ğŸ—ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ“ãƒ«ãƒ‰
      run: make build

    - name: ğŸ“Š é€±æ¬¡åŒ…æ‹¬æ€§èƒ½æ¸¬å®š
      run: |
        echo "ğŸ“Š é€±æ¬¡åŒ…æ‹¬æ€§èƒ½æ¸¬å®šå®Ÿè¡Œä¸­..."
        
        # åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        echo "âš¡ åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
        make bench-basic
        
        # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        echo "ğŸ”§ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
        make bench-compiler
        
        # ä»–è¨€èªæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
        echo "ğŸ æ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
        if command -v gcc >/dev/null 2>&1; then
          echo "  âœ… GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ"
          make bench-vs-gcc || echo "  âš ï¸ GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å¤±æ•—ï¼ˆç¶™ç¶šï¼‰"
        else
          echo "  âš ï¸ GCCåˆ©ç”¨ä¸å¯"
        fi
        
        if command -v rustc >/dev/null 2>&1; then
          echo "  âœ… Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ"
          make bench-vs-rust || echo "  âš ï¸ Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å¤±æ•—ï¼ˆç¶™ç¶šï¼‰"
        else
          echo "  âš ï¸ Ruståˆ©ç”¨ä¸å¯"
        fi

    - name: ğŸ“ˆ æ€§èƒ½ãƒ‡ãƒ¼ã‚¿åˆ†æ
      run: |
        echo "ğŸ“Š æ€§èƒ½ãƒ‡ãƒ¼ã‚¿åˆ†æå®Ÿè¡Œä¸­..."
        make bench-analyze || echo "âš ï¸ åˆ†æå‡¦ç†ã§è­¦å‘Šï¼ˆç¶™ç¶šï¼‰"

    - name: ğŸ“‰ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
      run: |
        echo "ğŸ“ˆ é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æå®Ÿè¡Œä¸­..."
        make bench-trend || echo "âš ï¸ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã§è­¦å‘Šï¼ˆç¶™ç¶šï¼‰"

    - name: ğŸ¨ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”Ÿæˆ
      run: |
        echo "ğŸ¨ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”Ÿæˆä¸­..."
        make bench-dashboard || echo "âš ï¸ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”Ÿæˆã§è­¦å‘Šï¼ˆç¶™ç¶šï¼‰"

    - name: ğŸ“ GitHub WikiåŒ…æ‹¬æ›´æ–°
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ“ GitHub WikiåŒ…æ‹¬æ›´æ–°å®Ÿè¡Œä¸­..."
        
        # Gitè¨­å®š
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Wikiè‡ªå‹•æ›´æ–°å®Ÿè¡Œ
        echo "ğŸš€ é€±æ¬¡Wikiæ›´æ–°ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œä¸­..."
        make bench-wiki
        
        if [ $? -eq 0 ]; then
          echo "âœ… é€±æ¬¡Wikiæ›´æ–°å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒšãƒ¼ã‚¸åŒ…æ‹¬æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ˆ é€²åŒ–å±¥æ­´ãƒ‡ãƒ¼ã‚¿è“„ç©ãƒ»æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ GCC/Rustæ¯”è¼ƒãƒ‡ãƒ¼ã‚¿æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“‰ é€±æ¬¡ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†ææ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¨ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ é€±æ¬¡Wikiæ›´æ–°ã§è­¦å‘ŠãŒç™ºç”Ÿã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ“Š é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        echo "ğŸ“Š é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        
        echo "## ğŸ“ˆ é€±æ¬¡æ€§èƒ½ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡Œã‚¿ã‚¤ãƒ—**: é€±æ¬¡åŒ…æ‹¬æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“‹ å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ€§èƒ½ãƒ‡ãƒ¼ã‚¿åˆ†æå®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æå®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… GitHub Wikiæ›´æ–°å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ”— ãƒªãƒ³ã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“Š æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ Wiki](https://github.com/nyasuto/pug/wiki/Performance-Benchmark)" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“š å­¦ç¿’ã‚¬ã‚¤ãƒ‰ Wiki](https://github.com/nyasuto/pug/wiki/Learning-Guide)" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ  Wiki ãƒ›ãƒ¼ãƒ ](https://github.com/nyasuto/pug/wiki)" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“¦ é€±æ¬¡ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: weekly-performance-reports-${{ github.run_number }}
        path: |
          performance-*.html
          performance-*.json
          trend-*.json
          dashboard-*.html
          dashboard-*.json
          *.s
        retention-days: 90  # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã¯90æ—¥ä¿æŒ