name: CI/CD - pug ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: 'stable'

jobs:
  # å“è³ªãƒã‚§ãƒƒã‚¯
  quality:
    name: ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('go.mod') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: ğŸ“‹ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: make deps

    - name: ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯ (fmt + lint + test)
      run: make quality

    - name: ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
      run: make test-cov

    - name: ğŸ“Š Phase1 ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./phase1.cover
        flags: phase1
        name: codecov-phase1
        fail_ci_if_error: false

    - name: ğŸ“Š Phase2 ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./phase2.cover
        flags: phase2
        name: codecov-phase2
        fail_ci_if_error: false

    - name: ğŸ“Š çµ±åˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.out
        name: codecov-combined
        fail_ci_if_error: false

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security:
    name: ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ›¡ï¸ Go ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ (gosec)
      uses: securego/gosec@master
      with:
        args: ./...

  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build:
    name: ğŸ”¨ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['stable']
    
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: make deps

    - name: ğŸ”¨ ãƒ“ãƒ«ãƒ‰
      run: make build

    - name: ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: make test

    - name: ğŸ“„ æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: binaries-ubuntu-go${{ matrix.go-version }}
        path: bin/

  # æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
  benchmark:
    name: âš¡ æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: make deps

    - name: ğŸ”¨ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ç”¨ãƒ“ãƒ«ãƒ‰
      run: |
        make build || echo "âš ï¸ ãƒ“ãƒ«ãƒ‰å¤±æ•—ï¼ˆç¶™ç¶šï¼‰"

    - name: âš¡ åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ
      run: |
        echo "ğŸš€ åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
        make bench > benchmark-basic.txt 2>&1 || true
        
    - name: ğŸ“Š åŒ…æ‹¬çš„ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ
      run: |
        echo "ğŸ“Š åŒ…æ‹¬çš„ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
        # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        go test -v -bench=BenchmarkCompiler ./benchmark/... > benchmark-compiler.txt 2>&1 || true
        
        # GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆGCCåˆ©ç”¨å¯èƒ½æ™‚ã®ã¿ï¼‰
        if command -v gcc >/dev/null 2>&1; then
          echo "ğŸ GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
          go test -v -bench=BenchmarkVsGCC ./benchmark/... > benchmark-gcc.txt 2>&1 || true
        else
          echo "âš ï¸ GCCãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€GCCæ¯”è¼ƒã‚’ã‚¹ã‚­ãƒƒãƒ—" > benchmark-gcc.txt
        fi
        
        # Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆRuståˆ©ç”¨å¯èƒ½æ™‚ã®ã¿ï¼‰
        if command -v cargo >/dev/null 2>&1; then
          echo "ğŸ¦€ Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
          go test -v -bench=BenchmarkVsRust ./benchmark/... -timeout=10m > benchmark-rust.txt 2>&1 || true
        else
          echo "âš ï¸ RustãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€Rustæ¯”è¼ƒã‚’ã‚¹ã‚­ãƒƒãƒ—" > benchmark-rust.txt
        fi
        
        # é€²åŒ–åˆ†æãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        echo "ğŸ“ˆ é€²åŒ–åˆ†æãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
        go test -v -bench=BenchmarkSuite ./benchmark/... > benchmark-evolution.txt 2>&1 || true

    - name: ğŸ“‹ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœçµ±åˆ
      run: |
        echo "ğŸ“‹ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœã‚’çµ±åˆä¸­..."
        cat > benchmark-comprehensive.txt << 'EOF'
        # ğŸº Pugã‚³ãƒ³ãƒ‘ã‚¤ãƒ©åŒ…æ‹¬çš„ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ
        
        å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S UTC')
        GitHub Actions Run: ${{ github.run_number }}
        ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
        ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
        
        ## ğŸ“Š åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        EOF
        cat benchmark-basic.txt >> benchmark-comprehensive.txt || true
        
        echo -e "\n\n## ğŸ”§ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> benchmark-comprehensive.txt
        cat benchmark-compiler.txt >> benchmark-comprehensive.txt || true
        
        echo -e "\n\n## ğŸ GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> benchmark-comprehensive.txt
        cat benchmark-gcc.txt >> benchmark-comprehensive.txt || true
        
        echo -e "\n\n## ğŸ¦€ Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> benchmark-comprehensive.txt
        cat benchmark-rust.txt >> benchmark-comprehensive.txt || true
        
        echo -e "\n\n## ğŸ“ˆ é€²åŒ–åˆ†æãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> benchmark-comprehensive.txt
        cat benchmark-evolution.txt >> benchmark-comprehensive.txt || true
        
        echo -e "\n\n---\nğŸ¤– Generated with [Claude Code](https://claude.ai/code)" >> benchmark-comprehensive.txt

    - name: ğŸ“Š GitHub Actions ã‚µãƒãƒªãƒ¼æ›´æ–°
      run: |
        echo "## ğŸš€ æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ å®Ÿè¡Œæ¦‚è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Runç•ªå·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚³ãƒŸãƒƒãƒˆ**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ”§ å®Ÿè¡Œã•ã‚ŒãŸãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (phase1/phase2)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (åŒ…æ‹¬çš„æ¸¬å®š)" >> $GITHUB_STEP_SUMMARY
        
        if command -v gcc >/dev/null 2>&1; then
          echo "- âœ… GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (ã‚¹ã‚­ãƒƒãƒ—)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if command -v cargo >/dev/null 2>&1; then
          echo "- âœ… Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (ã‚¹ã‚­ãƒƒãƒ—)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- âœ… é€²åŒ–åˆ†æãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“‹ è©³ç´°çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        head -100 benchmark-comprehensive.txt >> $GITHUB_STEP_SUMMARY || true
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "... (è©³ç´°ã¯Artifactsã‚’å‚ç…§)" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“ˆ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœä¿å­˜
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-comprehensive
        path: |
          benchmark-*.txt
        retention-days: 30

    - name: ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°æ¤œå‡º
      run: |
        echo "ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°æ¤œå‡ºä¸­..."
        # ç°¡æ˜“çš„ãªå›å¸°æ¤œå‡ºï¼ˆå®Ÿè£…ä¾‹ï¼‰
        if grep -q "FAIL" benchmark-comprehensive.txt; then
          echo "âš ï¸ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å¤±æ•—ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "::warning::ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        fi
        
        # TODO: éå»ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœã¨ã®æ¯”è¼ƒ
        echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°æ¤œå‡ºå®Œäº†" >> $GITHUB_STEP_SUMMARY

  # ãƒªãƒªãƒ¼ã‚¹æº–å‚™ï¼ˆã‚¿ã‚°ä½œæˆæ™‚ï¼‰
  release:
    name: ğŸš€ ãƒªãƒªãƒ¼ã‚¹
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [quality, security, build]
    
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ”¨ ãƒªãƒªãƒ¼ã‚¹ç”¨ãƒ“ãƒ«ãƒ‰
      run: |
        make clean
        make build
        
    - name: ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
      uses: softprops/action-gh-release@v2
      with:
        files: bin/*
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}