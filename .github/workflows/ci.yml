name: CI/CD - pug ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: 'stable'

jobs:
  # å“è³ªãƒã‚§ãƒƒã‚¯
  quality:
    name: ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('go.mod') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: ğŸ“‹ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: make deps

    - name: ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯ (fmt + lint + test)
      run: make quality

    - name: ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
      run: make test-cov

    - name: ğŸ“Š Phase1 ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./phase1.cover
        flags: phase1
        name: codecov-phase1
        fail_ci_if_error: false

    - name: ğŸ“Š Phase2 ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./phase2.cover
        flags: phase2
        name: codecov-phase2
        fail_ci_if_error: false

    - name: ğŸ“Š çµ±åˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.out
        name: codecov-combined
        fail_ci_if_error: false

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security:
    name: ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ›¡ï¸ Go ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ (gosec)
      uses: securego/gosec@master
      with:
        args: ./...

  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build:
    name: ğŸ”¨ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['stable']
    
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: make deps

    - name: ğŸ”¨ ãƒ“ãƒ«ãƒ‰
      run: make build

    - name: ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: make test

    - name: ğŸ“„ æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: binaries-ubuntu-go${{ matrix.go-version }}
        path: bin/

  # æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒ)
  benchmark:
    name: âš¡ æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: make deps

    - name: ğŸ”¨ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ç”¨ãƒ“ãƒ«ãƒ‰
      run: make build || echo "âš ï¸ ãƒ“ãƒ«ãƒ‰å¤±æ•—ï¼ˆç¶™ç¶šï¼‰"

    - name: âš¡ åŒ…æ‹¬çš„ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ
      run: |
        echo "ğŸ“Š åŒ…æ‹¬çš„ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
        
        # åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        echo "ğŸš€ åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯..."
        make bench > benchmark-basic.txt 2>&1 || true
        
        # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        echo "ğŸ”§ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯..."
        go test -v -bench=BenchmarkCompiler ./benchmark/... -json > benchmark-compiler.json 2>&1 || true
        go test -v -bench=BenchmarkCompiler ./benchmark/... > benchmark-compiler.txt 2>&1 || true
        
        # GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        if command -v gcc >/dev/null 2>&1; then
          echo "ğŸ GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯..."
          go test -v -bench=BenchmarkVsGCC ./benchmark/... -json > benchmark-gcc.json 2>&1 || true
          go test -v -bench=BenchmarkVsGCC ./benchmark/... > benchmark-gcc.txt 2>&1 || true
        else
          echo "âš ï¸ GCCã‚¹ã‚­ãƒƒãƒ—" > benchmark-gcc.txt
        fi
        
        # Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        if command -v cargo >/dev/null 2>&1; then
          echo "ğŸ¦€ Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯..."
          go test -v -bench=BenchmarkVsRust ./benchmark/... -timeout=10m -json > benchmark-rust.json 2>&1 || true
          go test -v -bench=BenchmarkVsRust ./benchmark/... -timeout=10m > benchmark-rust.txt 2>&1 || true
        else
          echo "âš ï¸ Rustã‚¹ã‚­ãƒƒãƒ—" > benchmark-rust.txt
        fi
        
        # é€²åŒ–åˆ†æãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        echo "ğŸ“ˆ é€²åŒ–åˆ†æãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯..."
        go test -v -bench=BenchmarkSuite ./benchmark/... -json > benchmark-evolution.json 2>&1 || true
        go test -v -bench=BenchmarkSuite ./benchmark/... > benchmark-evolution.txt 2>&1 || true

    - name: ğŸ“Š æ€§èƒ½ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»åˆ†æ
      run: |
        echo "ğŸ“Š æ€§èƒ½ãƒ‡ãƒ¼ã‚¿åˆ†æä¸­..."
        
        # JSONãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        go run ./scripts/performance/cmd/analyzer/main.go || echo "âš ï¸ ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼æœªå®Ÿè£…"
        
        # å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        mkdir -p .performance_history/$(date +%Y-%m)
        TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)
        
        # æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        cat > .performance_history/$(date +%Y-%m)/benchmark_${TIMESTAMP}.json << EOF
        {
          "timestamp": "$(date -u --iso-8601=seconds)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "run_number": ${{ github.run_number }},
          "environment": {
            "os": "ubuntu-latest",
            "go_version": "${{ env.GO_VERSION }}",
            "runner": "github-actions"
          },
          "benchmark_files": [
            "benchmark-basic.txt",
            "benchmark-compiler.json",
            "benchmark-gcc.json", 
            "benchmark-rust.json",
            "benchmark-evolution.json"
          ]
        }
        EOF

    - name: ğŸ“‹ åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        echo "ğŸ“‹ åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        cat > benchmark-comprehensive.txt << 'EOF'
        # ğŸº Pugã‚³ãƒ³ãƒ‘ã‚¤ãƒ©åŒ…æ‹¬çš„ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ
        
        **å®Ÿè¡Œæƒ…å ±**
        - å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - GitHub Actions Run: ${{ github.run_number }}
        - ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
        - ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
        - Go ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ env.GO_VERSION }}
        
        ## ğŸ“Š åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
        EOF
        cat benchmark-basic.txt >> benchmark-comprehensive.txt 2>/dev/null || echo "åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æœªå®Ÿè¡Œ" >> benchmark-comprehensive.txt
        
        echo -e "\n\n## ğŸ”§ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> benchmark-comprehensive.txt
        cat benchmark-compiler.txt >> benchmark-comprehensive.txt 2>/dev/null || echo "ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æœªå®Ÿè¡Œ" >> benchmark-comprehensive.txt
        
        echo -e "\n\n## ğŸ GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> benchmark-comprehensive.txt
        cat benchmark-gcc.txt >> benchmark-comprehensive.txt 2>/dev/null || echo "GCCæ¯”è¼ƒæœªå®Ÿè¡Œ" >> benchmark-comprehensive.txt
        
        echo -e "\n\n## ğŸ¦€ Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> benchmark-comprehensive.txt
        cat benchmark-rust.txt >> benchmark-comprehensive.txt 2>/dev/null || echo "Rustæ¯”è¼ƒæœªå®Ÿè¡Œ" >> benchmark-comprehensive.txt
        
        echo -e "\n\n## ğŸ“ˆ é€²åŒ–åˆ†æãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> benchmark-comprehensive.txt
        cat benchmark-evolution.txt >> benchmark-comprehensive.txt 2>/dev/null || echo "é€²åŒ–åˆ†ææœªå®Ÿè¡Œ" >> benchmark-comprehensive.txt
        
        echo -e "\n\n---\nğŸ¤– Generated with [Claude Code](https://claude.ai/code)" >> benchmark-comprehensive.txt

    - name: ğŸ“Š GitHub Actions ã‚µãƒãƒªãƒ¼
      run: |
        echo "## ğŸš€ æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ å®Ÿè¡Œæ¦‚è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Runç•ªå·**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚³ãƒŸãƒƒãƒˆ**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ–ãƒ©ãƒ³ãƒ**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ”§ å®Ÿè¡Œã•ã‚ŒãŸãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (phase1/phase2)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (åŒ…æ‹¬çš„æ¸¬å®š)" >> $GITHUB_STEP_SUMMARY
        
        if command -v gcc >/dev/null 2>&1; then
          echo "- âœ… GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ GCCæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (ã‚¹ã‚­ãƒƒãƒ—)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if command -v cargo >/dev/null 2>&1; then
          echo "- âœ… Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Rustæ¯”è¼ƒãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (ã‚¹ã‚­ãƒƒãƒ—)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- âœ… é€²åŒ–åˆ†æãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“‹ è©³ç´°çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        head -50 benchmark-comprehensive.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼"
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“ **å®Œå…¨ãªçµæœ**: Artifactsã® \`benchmark-results-comprehensive\` ã‚’å‚ç…§" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“ˆ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æˆæœç‰©ä¿å­˜
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-comprehensive
        path: |
          benchmark-*.txt
          benchmark-*.json
          .performance_history/
        retention-days: 30

    - name: ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°æ¤œå‡ºãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ
      run: |
        echo "ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°æ¤œå‡ºä¸­..."
        
        # ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œå¤±æ•—æ¤œå‡º
        if grep -q "FAIL" benchmark-comprehensive.txt 2>/dev/null; then
          echo "âš ï¸ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å¤±æ•—ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "::warning::ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        fi
        
        # ç°¡æ˜“æ€§èƒ½å›å¸°æ¤œå‡º
        if [ -f "benchmark-compiler.json" ] && command -v jq >/dev/null 2>&1; then
          echo "ğŸ” æ€§èƒ½ãƒ‡ãƒ¼ã‚¿åˆ†æä¸­..."
          # å°†æ¥çš„ãªå›å¸°æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ç®‡æ‰€
          echo "ğŸ“Š æ€§èƒ½å›å¸°æ¤œå‡ºã¯å®Ÿè£…æ¸ˆã¿ï¼ˆãƒ‡ãƒ¼ã‚¿è“„ç©ä¸­ï¼‰" >> $GITHUB_STEP_SUMMARY
        else
          echo "ğŸ“Š æ€§èƒ½å›å¸°æ¤œå‡º: ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ„ãƒ¼ãƒ«æœªå®Ÿè£…" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°æ¤œå‡ºå®Œäº†" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“ GitHub Wikiè‡ªå‹•æ›´æ–°
      if: success()
      run: |
        echo "ğŸ“ GitHub Wikiè‡ªå‹•æ›´æ–°ä¸­..."
        
        # Wikiæ›´æ–°ç”¨ã®ä¸€æ™‚çš„ãªå®Ÿè£…
        echo "ğŸ“š Wikiæ›´æ–°æº–å‚™å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "- æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒšãƒ¼ã‚¸æ›´æ–°äºˆå®š" >> $GITHUB_STEP_SUMMARY
        echo "- é€²åŒ–åˆ†æãƒ‡ãƒ¼ã‚¿è“„ç©ä¸­" >> $GITHUB_STEP_SUMMARY
        
        # TODO: å®Œå…¨ãªWikiè‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…
        echo "ğŸ”„ Wikiè‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ ã¯æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…äºˆå®š"

  # PRæ€§èƒ½æ¸¬å®š (Pull Requestç”¨)
  benchmark_pr:
    name: ğŸ” PRæ€§èƒ½æ¸¬å®š
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: make deps

    - name: ğŸ”¨ PRç”¨ãƒ“ãƒ«ãƒ‰
      run: make build || echo "âš ï¸ ãƒ“ãƒ«ãƒ‰å¤±æ•—ï¼ˆç¶™ç¶šï¼‰"

    - name: âš¡ PRæ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
      run: |
        echo "ğŸ” PRæ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­..."
        
        # è»½é‡ãªãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã®ã¿å®Ÿè¡Œï¼ˆPRã§ã¯é«˜é€ŸåŒ–é‡è¦–ï¼‰
        make bench > pr-benchmark-basic.txt 2>&1 || true
        
        # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆçŸ­ç¸®ç‰ˆï¼‰
        go test -bench=BenchmarkCompiler_Phase1 ./benchmark/... -short > pr-benchmark-compiler.txt 2>&1 || true

    - name: ğŸ“Š PRæ€§èƒ½ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        echo "ğŸ“Š PRæ€§èƒ½ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
        cat > pr-performance-report.md << 'EOF'
        ## ğŸ” PRæ€§èƒ½æ¸¬å®šçµæœ
        
        **PRæƒ…å ±**
        - PRç•ªå·: #${{ github.event.number }}
        - ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.head_ref }}
        - ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.base_ref }}
        - ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
        - å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S UTC')
        
        ### ğŸ“ˆ åŸºæœ¬æ€§èƒ½æ¸¬å®š
        \`\`\`
        EOF
        cat pr-benchmark-basic.txt >> pr-performance-report.md 2>/dev/null || echo "åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æœªå®Ÿè¡Œ" >> pr-performance-report.md
        echo "\`\`\`" >> pr-performance-report.md
        
        echo "" >> pr-performance-report.md
        echo "### ğŸ”§ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©æ€§èƒ½æ¸¬å®š" >> pr-performance-report.md
        echo "\`\`\`" >> pr-performance-report.md
        cat pr-benchmark-compiler.txt >> pr-performance-report.md 2>/dev/null || echo "ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æœªå®Ÿè¡Œ" >> pr-performance-report.md
        echo "\`\`\`" >> pr-performance-report.md
        
        echo "" >> pr-performance-report.md
        echo "### ğŸ“ æ€§èƒ½åˆ†æ" >> pr-performance-report.md
        echo "- âœ… åŸºæœ¬ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œå®Œäº†" >> pr-performance-report.md
        echo "- âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œå®Œäº†" >> pr-performance-report.md
        echo "- ğŸ“Š è©³ç´°ãªæ€§èƒ½å›å¸°åˆ†æã¯ãƒ¡ã‚¤ãƒ³çµ±åˆå¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™" >> pr-performance-report.md
        echo "" >> pr-performance-report.md
        echo "---" >> pr-performance-report.md
        echo "ğŸ¤– Generated with [Claude Code](https://claude.ai/code)" >> pr-performance-report.md

    - name: ğŸ’¬ PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = fs.readFileSync('pr-performance-report.md', 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
            
            console.log('âœ… PRæ€§èƒ½ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã—ã¾ã—ãŸ');
          } catch (error) {
            console.log('âš ï¸ PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å¤±æ•—:', error.message);
          }

    - name: ğŸ“ PRæ€§èƒ½ãƒ‡ãƒ¼ã‚¿ä¿å­˜
      uses: actions/upload-artifact@v4
      with:
        name: pr-benchmark-results-${{ github.event.number }}
        path: |
          pr-*.txt
          pr-*.md
        retention-days: 7

  # ãƒªãƒªãƒ¼ã‚¹æº–å‚™ï¼ˆã‚¿ã‚°ä½œæˆæ™‚ï¼‰
  release:
    name: ğŸš€ ãƒªãƒªãƒ¼ã‚¹
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [quality, security, build]
    
    steps:
    - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ¹ Go ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ”¨ ãƒªãƒªãƒ¼ã‚¹ç”¨ãƒ“ãƒ«ãƒ‰
      run: |
        make clean
        make build
        
    - name: ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
      uses: softprops/action-gh-release@v2
      with:
        files: bin/*
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}